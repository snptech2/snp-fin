# Enhanced Cash Flow Logic - Investment Tracking System

## ðŸ“– Panoramica

Questo documento definisce la **logica Enhanced Cash Flow** utilizzata per tracciare investimenti in tutti i tipi di portfolio nell'applicazione. Questa logica fornisce una visione chiara e unificata di:
- Quanto Ã¨ stato investito originalmente
- Quanto capitale Ã¨ stato recuperato
- Quanto denaro Ã¨ ancora "a rischio"
- Profitti/perdite realizzati e non realizzati

## ðŸŽ¯ Principi Fondamentali

### Metriche Core
```
totalInvested = Î£ di tutte le transazioni BUY storiche (invariante)
capitalRecovered = Î£ di tutte le transazioni SELL storiche
effectiveInvestment = max(0, totalInvested - capitalRecovered)
realizedProfit = max(0, capitalRecovered - totalInvested)
unrealizedProfit = valoreAttuale - effectiveInvestment
```

### Caratteristiche Chiave
- **totalInvested**: Non cambia mai, rappresenta l'investimento storico totale
- **capitalRecovered**: Aumenta ad ogni vendita, indipendentemente dal prezzo
- **effectiveInvestment**: Denaro ancora "a rischio", puÃ² arrivare a zero
- **realizedProfit**: Esiste solo DOPO aver recuperato tutto l'investimento iniziale
- **unrealizedProfit**: Guadagno potenziale sugli holdings attuali

## ðŸ“Š Esempi Pratici

### Esempio 1: DCA Bitcoin
```
Situazione:
- Compro: 1 BTC a 1.000â‚¬
- BTC sale a 1.500â‚¬/BTC
- Vendo: 0.5 BTC per 750â‚¬
- Holdings: 0.5 BTC del valore di 750â‚¬

Calcoli:
totalInvested = 1.000â‚¬
capitalRecovered = 750â‚¬
effectiveInvestment = 1.000â‚¬ - 750â‚¬ = 250â‚¬
realizedProfit = 0â‚¬ (non ho ancora recuperato tutto)
unrealizedProfit = 750â‚¬ - 250â‚¬ = 500â‚¬
```

### Esempio 2: Recovery Completo + Profitto
```
Situazione (continua esempio 1):
- BTC sale a 3.000â‚¬/BTC  
- Vendo: 0.25 BTC per 750â‚¬
- Holdings: 0.25 BTC del valore di 750â‚¬

Calcoli:
totalInvested = 1.000â‚¬
capitalRecovered = 750â‚¬ + 750â‚¬ = 1.500â‚¬
effectiveInvestment = max(0, 1.000â‚¬ - 1.500â‚¬) = 0â‚¬ ("investimento gratis")
realizedProfit = 1.500â‚¬ - 1.000â‚¬ = 500â‚¬
unrealizedProfit = 750â‚¬ - 0â‚¬ = 750â‚¬
```

### Esempio 3: Crypto Wallet Multi-Asset
```
Situazione:
- Compro: 1 BTC a 1.000â‚¬ + 10 ETH a 2.000â‚¬ + 100 SOL a 500â‚¬
- totalInvested = 3.500â‚¬
- Vendo: 0.5 BTC (750â‚¬) + 5 ETH (2.000â‚¬)
- capitalRecovered = 2.750â‚¬

Calcoli:
effectiveInvestment = 3.500â‚¬ - 2.750â‚¬ = 750â‚¬
realizedProfit = 0â‚¬ (non ancora recovery completo)
Holdings attuali = 0.5 BTC + 5 ETH + 100 SOL = 52.500â‚¬ (esempio)
unrealizedProfit = 52.500â‚¬ - 750â‚¬ = 51.750â‚¬
```

## ðŸ”§ Implementazione Tecnica

### Formule per Backend API
```javascript
function calculateEnhancedStats(transactions) {
  const buyTransactions = transactions.filter(tx => tx.type === 'buy')
  const sellTransactions = transactions.filter(tx => tx.type === 'sell')
  
  const totalInvested = buyTransactions.reduce((sum, tx) => sum + tx.eurValue, 0)
  const capitalRecovered = sellTransactions.reduce((sum, tx) => sum + tx.eurValue, 0)
  const effectiveInvestment = Math.max(0, totalInvested - capitalRecovered)
  const realizedProfit = Math.max(0, capitalRecovered - totalInvested)
  
  return {
    totalInvested,
    capitalRecovered, 
    effectiveInvestment,
    realizedProfit,
    isFullyRecovered: capitalRecovered >= totalInvested
  }
}
```

### Calcolo ROI
```javascript
// Per calcolare unrealized profit nel frontend:
const currentValue = holdings.reduce((sum, h) => sum + h.valueEur, 0)
const unrealizedProfit = currentValue - stats.effectiveInvestment

// ROI Totale
const totalROI = stats.totalInvested > 0 ? 
  ((stats.realizedProfit + unrealizedProfit) / stats.totalInvested) * 100 : 0
```

## ðŸŽ¯ Applicazioni

### Portfolio DCA Bitcoin
- Applica la logica Enhanced direttamente
- Holdings singolo asset (BTC)
- Include fee di rete nel calcolo delle quantitÃ 

### Portfolio Crypto Wallet Multi-Asset  
- Applica la stessa logica Enhanced a livello di portfolio
- Holdings multipli asset
- Visione unificata dell'intero wallet
- **FEATURE DA IMPLEMENTARE**: Swap interni tra asset

## ðŸš€ FunzionalitÃ  Future

### Swap Interno tra Asset
I crypto wallet dovranno supportare la funzionalitÃ  di **swap interno** tra asset senza uscire dal wallet:

```
Esempio:
- Swap: 1 ETH â†’ 0.01 BTC
- NON modifica totalInvested, capitalRecovered o effectiveInvestment
- Aggiorna solo le quantitÃ  degli holdings interni
- Mantiene la stessa logica Enhanced Cash Flow
```

**Implementazione Swap:**
- Nuova transazione type: 'swap'
- Due operazioni atomiche: sell asset A + buy asset B
- Nessun impatto su metriche cash flow (solo redistribuzione interna)
- Tracciamento dello swap per audit trail

## ðŸ“ˆ Vantaggi della Logica Enhanced

âœ… **SemplicitÃ **: Facile da capire e spiegare  
âœ… **Coerenza**: Stessa logica per tutti i tipi di portfolio  
âœ… **Informativa**: Traccia capitale a rischio vs recuperato  
âœ… **Scalabile**: Funziona con 1 o 100 asset diversi  
âœ… **Realistica**: Distingue tra profitti realizzati e potenziali  

## ðŸ”„ CompatibilitÃ 

Questa logica mantiene compatibilitÃ  con i sistemi esistenti attraverso:
- Mapping dei valori legacy quando necessario
- Calcoli Enhanced come fonte primaria di veritÃ 
- Frontend unificato che mostra sempre le stesse metriche

---

**Versione**: 1.0  
**Data**: Giugno 2025  
**Status**: Definizione Completa - Pronto per Implementazione