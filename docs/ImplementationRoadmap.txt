# Implementation Roadmap - Enhanced Cash Flow Fix

## ðŸš¨ Problemi Identificati

### Portfolio testbtc (DCA Bitcoin) - Incongruenze Critiche
- **Holdings quantity**: âœ… Corretto (0.0049 BTC con 1000 sats fee)
- **Costo Base Rimasto**: âŒ Mostra 100â‚¬, dovrebbe essere 250â‚¬  
- **ROI calculations**: âŒ Tre valori diversi (-8.32%, 101.68%, -100â‚¬ P&L)
- **Enhanced logic**: âŒ Non applicata correttamente ovunque

### Portfolio testcrypto (Crypto Wallet) - ROI Inconsistente  
- **Profitti Realizzati**: âœ… 85â‚¬ corretto
- **ROI**: âŒ Varia tra +120%, +170%, altri valori
- **Dovrebbe essere**: (85â‚¬ + 100.21â‚¬) Ã· 50â‚¬ = **370.42%**

## ðŸŽ¯ Implementazione in 3 Fasi

### FASE 1: Correzioni Critiche (PRIORITÃ€ 1)

#### Backend API Fixes
**File da modificare:**
```
src/app/api/dca-portfolios/[id]/route.ts
src/app/api/crypto-portfolios/[id]/route.ts  
src/app/api/crypto-portfolios/route.ts
```

**Logica Enhanced da applicare:**
```javascript
// UNIFICA TUTTI I CALCOLI CON QUESTA LOGICA
const totalInvested = buyTransactions.reduce((sum, tx) => sum + tx.eurValue, 0)
const capitalRecovered = sellTransactions.reduce((sum, tx) => sum + tx.eurValue, 0)
const effectiveInvestment = Math.max(0, totalInvested - capitalRecovered)
const realizedProfit = Math.max(0, capitalRecovered - totalInvested)

// Per unrealized nel frontend:
const unrealizedProfit = currentValue - effectiveInvestment
const totalROI = ((realizedProfit + unrealizedProfit) / totalInvested) * 100
```

#### Frontend Calculation Fixes
**File da modificare:**
```
src/app/investments/page.tsx (calculateTotalROI function)
src/app/investments/[id]/page.tsx (totalROI calculation)
src/app/investments/crypto-portfolio/[id]/page.tsx
```

**Rimuovere calcoli duplicati e usare solo Enhanced stats dal backend.**

### FASE 2: Unificazione Completa

#### Standardizzare Enhanced Logic
**File da rivedere:**
```
src/app/api/dca-portfolios/route.ts (calculateEnhancedStats)
src/components/investments/DCAStatsGrid.tsx
src/app/accounts/page.tsx (breakdown calculations)
```

**Obiettivo**: Stessa logica Enhanced ovunque, rimuovere legacy calculations.

#### Frontend Consistency
**Assicurarsi che tutti i componenti mostrino:**
- totalInvested (invariante)
- capitalRecovered  
- effectiveInvestment (soldi a rischio)
- realizedProfit vs unrealizedProfit
- ROI calcolato allo stesso modo

### FASE 3: Swap Functionality

#### Nuove API da creare
```
src/app/api/crypto-portfolios/[id]/swap/route.ts
```

**Logica swap:**
```javascript
// Swap non modifica Enhanced metrics
// Solo redistribuisce holdings interni
// Due operazioni atomiche: sell asset A + buy asset B
// Ma senza impatto su totalInvested/capitalRecovered
```

#### UI Components
```
components/crypto/SwapModal.tsx
components/crypto/SwapInterface.tsx
```

**Integrazione in:**
```
src/app/investments/crypto-portfolio/[id]/page.tsx
```

## ðŸ“Š Test Cases per Validazione

### testbtc (DCA Bitcoin) - Valori Corretti Attesi
```
Transazioni:
- Buy: 0.01 BTC per 500â‚¬
- Sell: 0.005 BTC per 400â‚¬  
- Holdings: 0.0049 BTC (con 1000 sats fee)

Calcoli Enhanced:
totalInvested = 500â‚¬
capitalRecovered = 400â‚¬
effectiveInvestment = 100â‚¬
realizedProfit = 0â‚¬ (400â‚¬ < 500â‚¬)

Se BTC = 91.859â‚¬:
currentValue = 0.0049 Ã— 91.859â‚¬ = 450,11â‚¬
unrealizedProfit = 450,11â‚¬ - 100â‚¬ = 350,11â‚¬
totalROI = (0â‚¬ + 350,11â‚¬) / 500â‚¬ = 70.02%
```

### testcrypto (Crypto Wallet) - Valori Corretti Attesi  
```
Transazioni SOL:
- Buy: 2 SOL per 50â‚¬ (25â‚¬ each)
- Sell: 1 SOL per 110â‚¬
- Holdings: 1 SOL

Calcoli Enhanced:
totalInvested = 50â‚¬
capitalRecovered = 110â‚¬  
effectiveInvestment = 0â‚¬ (fully recovered)
realizedProfit = 110â‚¬ - 50â‚¬ = 60â‚¬

Se SOL = 125,21â‚¬:
currentValue = 1 Ã— 125,21â‚¬ = 125,21â‚¬
unrealizedProfit = 125,21â‚¬ - 0â‚¬ = 125,21â‚¬
totalROI = (60â‚¬ + 125,21â‚¬) / 50â‚¬ = 370.42%
```

## ðŸ”§ File Priority List

### CRITICO (Fix immediato)
1. `src/app/api/dca-portfolios/[id]/route.ts` - Enhanced stats
2. `src/app/api/crypto-portfolios/[id]/route.ts` - Enhanced stats  
3. `src/app/investments/[id]/page.tsx` - ROI calculation
4. `src/app/investments/crypto-portfolio/[id]/page.tsx` - ROI calculation

### IMPORTANTE (Unificazione)
5. `src/app/investments/page.tsx` - Overview calculations
6. `src/app/api/crypto-portfolios/route.ts` - List stats
7. `src/components/investments/DCAStatsGrid.tsx` - Display logic

### FEATURE (Swap)
8. Nuove API per swap functionality
9. Nuovi componenti UI per swap
10. Integrazione con Enhanced logic

## âš ï¸ Note Implementazione

- **Sempre testare** con portfolio esistenti (testbtc, testcrypto)
- **Backup logic**: Mantenere compatibility temporanea se necessario
- **Enhanced = source of truth**: Tutti i calcoli devono derivare da Enhanced stats
- **Frontend semplificato**: Rimuovere calcoli duplicati, usare solo backend stats
- **Swap = no cash flow impact**: Solo redistribuzione holdings interna

---

**Per nuova chat**: Leggere questo documento + `DOCS/EnhancedCashFlowLogic.txt`, poi procedere con FASE 1.